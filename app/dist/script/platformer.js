!function(a,b){"function"==typeof define&&define.amd?define(["exports"],function(c){b(a,c)}):"function"==typeof define&&seajs?define(function(c,d){b(a,d)}):"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?b(a,exports):a.Platformer=b(a,{})}(this,function(a,b,c){function d(a){return function(b){return{}.toString.call(b)=="[object "+a+"]"}}window.RequestAnimationFrame=function(){var a,b,d=0,e=navigator.userAgent,f=0,g=this;return window.webkitRequestAnimationFrame&&(b=function(a){a===c&&(a=Date.now()),g._callback(a)},a=window.webkitRequestAnimationFrame,window.webkitRequestAnimationFrame=function(c,d){g._callback=c,a(b,d)}),window.mozRequestAnimationFrame&&(f=e.indexOf("rv:"),-1!=e.indexOf("Gecko")&&(d=e.substr(f+3,3),"2.0"===d&&(window.mozRequestAnimationFrame=c))),window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){var b,c;window.setTimeout(function(){b=Date.now(),a(b),c=Date.now(),g.timeout=1e3/60-(c-b)},g.timeout)}}(),b.Resize=function(){function a(){e||(e=!0,window.RequestAnimationFrame(b))}function b(){for(var a=0;a<d.length;a++)d[a]();e=!1}function c(a){a&&d.push(a)}var d=[],e=!1;return{init:function(b){window.addEventListener("resize",a),c(b)},add:function(a){c(a)}}}();var e=d("Object"),f=d("String"),g=d("Number"),h=Array.isArray||d("Array"),i=d("Function"),j={};b.config=function(a){for(var b in a){var c=a[b],d=j[b];if(d&&e(d))for(var f in c)d[f]=c[f];else h(d)&&(c=d.concat(c)),j[b]=c}};var k=0,l=function(a){this.ins=a,this.offset=0,this.velocity=0,this.spritesColleaction=[],this._width=a.width,this._height=a.height,this.context=a.getContext("2d")};l.prototype={constructor:l,clear:function(){this.context.clearRect(0,0,this.width(),this.height())},width:function(a){return a&&(a=a<this.minWidth?this.minWidth:a,a=a>this.maxWidth?this.maxWidth:a,this._width=this.ins.width=a),this._width},height:function(a){return a&&(a=a<this.minHeight?this.minHeight:a,a=a>this.maxHeight?this.maxHeight:a,this._height=this.ins.height=a),this._height},add:function(a){-1==this.spritesColleaction.indexOf(a)&&(k=k>a.width()?k:a.width(),this.spritesColleaction.push(a))},remove:function(a){-1!=this.spritesColleaction.indexOf(a)&&this.spritesColleaction.splice(this.spritesColleaction.indexOf(a),1)},moveToLeft:function(a){this.velocity=-a},moveToRight:function(a){this.velocity=a},stop:function(){this.velocity=0},canMoveToLeft:function(){return(0!==this.velocity||0!==this.offset)&&this.offset>0&&this.velocity<0},canMoveToRight:function(){return(0!==this.velocity||0!==this.offset)&&this.offset<=k-this.width()&&this.velocity>0},beforeUpdate:function(a){(this.canMoveToLeft()||this.canMoveToRight())&&(this.offset+=this.velocity/a);for(var b=0;b<this.spritesColleaction.length;b++)this.spritesColleaction[b].offset=this.offset;this.context.translate(-this.offset,0)},afterUpdate:function(){this.context.translate(this.offset,0)}},b.Canvas=function(){var a={};return{instance:function(b){if(b&&a[b])return a[b];if(b){var c=document.getElementById(b);return a[b]=new l(c),a[b]}}}}();var m=["Left","Width","Top","Height"],n=["Left","Width"],o=["Top","Height"],p="init",q="computed",r=b.Sprite=function(a,b,d){this.type=a||"",this.artist=b||c,this.needCompute=m.slice(0,m.length),this.behaviors=d||[],this.equipBehaviors(),this._relative={},this.left(0),this.top(0),this.width(0),this.height(0),this.offset=0,this.visible=!0,this.color="#fff"};r.prototype.drawTo=function(a){this.canvas=a,this.compute(),this.canvas.add(this)},r.prototype.equipBehaviors=function(){for(var a=0;a<this.behaviors.length;a++)i(this.behaviors[a].decorate)&&this.behaviors[a].decorate(this)},r.prototype.draw=function(){this.artist&&this.artist instanceof b.Artist&&this.canvas&&this.artist.draw(this,this.canvas.context)},r.prototype.show=function(){this.visible=!0},r.prototype.hide=function(){this.visible=!1},r.prototype.update=function(a,c){for(var d=0;d<this.behaviors.length;d++){var e=this.behaviors[d];if(e instanceof b.Behavior){if(e.execute(this,a,c,this.canvas.context,b.Platform.instance()),!e.isDone)continue;i(e.done)&&e.done(this),this.behaviors.splice(d,1)}}},r.prototype.compute=function(a){if(-1!=m.indexOf(a))return void this._compute(a);for(var b=0,c=this.needCompute.length;c>b;b++)this._compute(this.needCompute[b]);if(this.isCenter){var d=this._relative.center||this.canvas;this.left(.5*(d.width()-this.width())/d.width()*100+"%")}},r.prototype.center=function(a){a&&(this._relativeTo.center=a),this.isCenter=!0},r.prototype._compute=function(a){var b="_"+p+a,c="_"+q+a,d=0,e=this._relative[a]||this.canvas;if(/%/.test(this[b])){if(!e)return;-1!=n.indexOf(a)?d=e.width():-1!=o.indexOf(a)&&(d=e.height()),this[c]=parseInt(.01*parseFloat(this[b])*d)}else/auto/.test(this[b])?"Width"==a?this[c]=parseInt(this.height()*this.aspectRatio):"Height"==a&&(this[c]=parseInt(this.width()/this.aspectRatio)):g(this[b])&&(this[c]=parseInt(this[b]));this[c]=this[c]<this["min"+a]?this["min"+a]:this[c],this[c]=this[c]>this["max"+a]?this["max"+a]:this[c]},r.prototype.attr=function(a,d,e){if(a){null!==d&&d!==c&&(this["_"+p+a]=d,(e instanceof b.Sprite||e instanceof l)&&(this._relative[a]=e),this._compute(a));var f=/auto/.test(d),g=/%/.test(d);if(f||g){this.needCompute.splice(this.needCompute.indexOf(a),1);var h=f?this.needCompute.length:0;this.needCompute.splice(h,0,a)}return this["_"+q+a]}};for(var s=0,t=m.length;t>s;s++)!function(a){r.prototype[m[a].toLowerCase()]=function(b,c){return this.attr(m[a],b,c)},r.prototype[p+m[a]]=function(){return this["_"+p+m[a]]}}(s);var u=b.Stopwatch=function(a){this.duration=a,this.startTime=0,this.running=!1,this.elapsed=c,this.paused=!1,this.startPause=0,this.totalPausedTime=0};u.prototype={constructor:u,start:function(){this.startTime=Date.now(),this.running=!0,this.totalPausedTime=0,this.startPause=0},stop:function(){this.paused&&this.unpause(),this.elapsed=Date.now()-this.startTime-this.totalPausedTime,this.running=!1},pause:function(){this.startPause=Date.now(),this.paused=!0},unpause:function(){this.paused&&(this.totalPausedTime+=Date.now()-this.startPause,this.startPause=0,this.paused=!1)},getElapsedTime:function(){return this.running?Date.now()-this.startTime-this.totalPausedTime:this.elapsed},getPercentageComplete:function(){return this.getElapsedTime()/this.duration},isPaused:function(){return this.paused},isRunning:function(){return this.running},isDone:function(){return this.getElapsedTime()>this.duration},reset:function(){this.elapsed=0,this.startTime=Date.now(),this.running=!1,this.totalPausedTime=0,this.startPause=0}};var v=b.NotificationCenter=function(){function a(){return{add:function(a){if(e(a)&&-1==c.indexOf(a))c.push(a);else if(h(a))for(var b=0;b<a.length;b++)this.add(a[b])},turnOn:function(){d=!0},turnOff:function(){d=!1},listen:function(){if(d)for(var a=0;a<c.length;a++){var b=c[a];b.when(b.sender,b.receiver)&&b.do(b.sender,b.receiver)}}}}var b=null,c=[],d=!1;return{instance:function(){return b||(b=a()),b}}}(),w=b.Artist=function(){};w.prototype.draw=function(a,b){b.save(),this.onDraw(a,b),b.restore()},w.prototype.onDraw=function(){throw new Error("Unsupported operation on an abstract class")};var x=b.Behavior=function(){};x.prototype.decorate=function(){},x.prototype.execute=function(){throw new Error("Unsupported operation on an abstract class")};var y=b.extend=function(a){var b,c=this;b=e(a)&&a.hasOwnProperty("constructor")?function(){c.apply(this,arguments),a.constructor.apply(this,arguments)}:function(){c.apply(this,arguments)};var d=function(){this.constructor=b};d.prototype=c.prototype,b.prototype=new d;var f;for(f in c)b[f]=c[f];for(f in a)"constructor"!=f&&(b.prototype[f]=a[f]);return b};r.extend=w.extend=x.extend=u.extend=y,b.RecArtist=w.extend({onDraw:function(a,b){b.fillStyle=a.color,b.fillRect(a.left(),a.top(),a.width(),a.height())}}),b.SpriteSheetArtist=w.extend({constructor:function(a,b,c){this.image=document.createElement("img"),this.spritesheet=a,this.cells=b,this.callback=c,this.cellIndex=0},advance:function(){return this.cellIndex>=this.cells.length-1?this.cellIndex=0:this.cellIndex++,this.cellIndex},onDraw:function(a,b){function c(){e.loadComplete=!0,b.drawImage(this,d.left,d.top,d.width,d.height,a.left(),a.top(),a.width(),a.height()),i(e.callback)&&e.callback.call(this)}if(this.cells&&this.cells.length){var d=this.cells[this.cellIndex];this.loadComplete?b.drawImage(this.image,d.left,d.top,d.width,d.height,a.left(),a.top(),a.width(),a.height()):(this.image.onload=c,this.image.src=this.spritesheet);var e=this}}}),b.CycleBehavior=x.extend({constructor:function(a){this.lastAdvanceTime=0,this._decorate=i(a)?a:function(){}},decorate:function(a){a.animationRate=0,this._decorate(a)},execute:function(a,b){0!==a.animationRate&&(0===this.lastAdvanceTime?this.lastAdvanceTime=b:b-this.lastAdvanceTime>1e3/a.animationRate&&(a.artist.advance(),this.lastAdvanceTime=b))}}),b.TimeBehavior=x.extend({constructor:function(a){this.start=a.start,this.end=a.end,this._decorate=a.decorate,this.duration=a.duration||1e3,this.easing=a.easing||b.AnimationTimer.linear(),this.stopwatch=new b.AnimationTimer(this.duration,this.easing)},decorate:function(a){if(!this.stopwatch.isRunning()){var b=this;a[this._decorate]=function(c){if(!b.stopwatch.isRunning()){b.stopwatch.start(),b.callback=c;for(var d in b.end){var e=d.toLowerCase();e=d.charAt(0).toUpperCase()+d.slice(1),i(a[p+e])&&(b["init"+d]=b.end[d],b.start[d]=a[d](b.start[d]),b.end[d]=a[d](b.end[d]))}}}}},execute:function(a){var b=this.stopwatch;if(b.isRunning()){var c;if(b.isDone()){i(this.callback)&&this.callback(),this.isDone=!0;for(c in this.end)f(this["init"+c])&&a[c](this["init"+c])}else for(c in this.end){var d=b.getPercentageComplete()*(this.end[c]-this.start[c]);a[c](this.start[c]+d)}}},done:function(a){this.start=null,this.end=null,this.stopwatch=null,a[this._decorate]=null}}),b.MoveBehavior=x.extend({constructor:function(a){this._decorate=i(a)?a:function(a){a.moveToLeft=function(b){a.velocityX=-b},a.moveToRight=function(b){a.velocityX=b},a.moveToTop=function(b){a.velocityY=-b},a.moveToBottom=function(b){a.velocityY=b},a.stopMove=function(){a.velocityX=0,a.velocityY=0}}},decorate:function(a){a.velocityX=0,a.velocityY=0,this._decorate(a)},execute:function(a,b,c){var d,e,f;0!==a.velocityX&&(d=a.velocityX/c,/%/.test(a.initLeft())?(f=a._relative.Left||a.canvas,e=(a.left()+d)/f.width()*100+"%"):e=a.left(),a.left(e)),0!==a.velocityY&&(d=a.velocityY/c,/%/.test(a.initTop())?(f=a._relative.Top||a.canvas,e=(a.top()+d)/f.height()*100+"%"):e=a.top(),a.top(e))}}),b.JumpBehavior=x.extend({decorate:function(a){a.JUMP_HEIGHT=120,a.JUMP_DURATION=1e3,a.jumping=!1,a.ascendStopwatch=new b.AnimationTimer(a.JUMP_DURATION/2,b.AnimationTimer.easeOut(1.2)),a.descendStopwatch=new b.AnimationTimer(a.JUMP_DURATION/2,b.AnimationTimer.easeIn(1.2));var c=this;a.jump=function(){this.jumping||(c.initTop=this.initTop(),this.jumping=!0,this.animationRate=0,this.verticalLaunchPosition=this.top(),this.ascendStopwatch.start())}},execute:function(a){if(a.jumping){if(this.isJumpOver(a))return void(a.juming=!1);var b=a.ascendStopwatch,c=a.descendStopwatch;b.isRunning()?b.isDone()?this.finishAscent(a):this.ascend(a):c.isRunning()&&(c.isDone()?this.finishDescent(a):this.descend(a))}},isJumpOver:function(a){return!a.ascendStopwatch.isRunning()&&!a.descendStopwatch.isRunning()},ascend:function(a){var b=a.ascendStopwatch.getPercentageComplete()*a.JUMP_HEIGHT;a.top(a.verticalLaunchPosition-b)},finishAscent:function(a){a.jumpApex=a.top(),a.ascendStopwatch.stop(),a.descendStopwatch.start()},descend:function(a){var b=a.descendStopwatch.getPercentageComplete()*a.JUMP_HEIGHT;a.top(a.jumpApex+b)},finishDescent:function(a){a.top(a.verticalLaunchPosition),a.descendStopwatch.stop(),a.jumping=!1,a.animationRate=10,a.top(this.initTop)}}),b.CollideBehavior=x.extend({constructor:function(a){this.canvas=a.canvas,this.allSprite=[],this.processCollision=a.processCollision||function(){}},getSprite:function(a){if(!this.allSprite.length)if(e(this.canvas))Array.prototype.push.apply(this.allSprite,this.canvas.spritesColleaction);else if(h(this.canvas))for(var b=0;b<this.canvas.length;b++)Array.prototype.push.apply(this.allSprite,this.canvas[b].spritesColleaction);else this.allSprite=a.get("sprite")},execute:function(a,b,c,d,e){this.getSprite(e);for(var f=0,g=this.allSprite.length;g>f;f++){var h=this.allSprite[f];this.isCandidateForCollision(a,h)&&this.didCollide(a,h,d)&&(console.log(h.type),this.processCollision(a,h))}},isCandidateForCollision:function(a,b){return a!==b&&a.visible&&b.visible&&b.left()-b.offset<a.left()+a.width()},didCollide:function(a,b,c){var d=10,e=10,f=10,g=0,h=a.left()+a.offset+e,i=a.left()+a.offset+a.width()+f,j=a.top()+d,k=a.top()+a.height()+g,l=h+a.width()/2,m=a.top()+a.height()/2;return c.beginPath(),c.rect(b.left()-b.offset,b.top(),b.width(),b.height()),c.isPointInPath(h,j)||c.isPointInPath(i,j)||c.isPointInPath(l,m)||c.isPointInPath(h,k)||c.isPointInPath(i,k)}});var z=b.AnimationTimer=u.extend({constructor:function(a,b){this.transducer=b,this.duration=a||1e3},isExpired:function(){return this.getElapsedTime()>this.duration},getElapsedTime:function(){var a;a=this.running?Date.now()-this.startTime-this.totalPausedTime:this.elapsed;var b=a/this.duration;return b>=1&&(b=1),this.transducer!==c&&b>0&&(a*=this.transducer(b)/b),a}});z.easeOut=function(a){return a=a?a:1,function(b){return 1-Math.pow(1-b,2*a)}},z.easeIn=function(a){return a=a?a:1,function(b){return Math.pow(b,2*a)}},z.elastic=function(a){return a=a||3,function(b){return(1-Math.pow(b*Math.PI*a))*(1-b)+b}},z.bounce=function(a){var b=AnimationTimer.elastic(a);return a=a||2,function(a){return a=b(a),1>=a?a:2-a}},z.linear=function(){return function(a){return a}},b.Platform=function(){function a(){return{calculateFps:function(a){return this.fps=parseInt(1e3/(a-g)),g=a,this.fps},layout:function(a){function c(){e.clear(),a();for(var b=0;b<d.length;b++)d[b].compute();e.redraw()}var e=this;return c(),b.Resize.init(c),this},start:function(a){-1==f.indexOf(a)&&i(a)&&f.push(a)},execStart:function(a){for(var b=0;b<f.length;)f[b](a),f.splice(b,1)},update:function(a){function b(d){v.instance().listen(),c.execStart(d),a(d),c.redraw(d),window.RequestAnimationFrame(b)}var c=this;window.RequestAnimationFrame(b)},add:function(a){if(a instanceof b.Sprite&&-1==d.indexOf(a))d.push(a);else if(a instanceof l&&-1==e.indexOf(a))e.push(a);else if(h(a))for(var c=0;c<a.length;c++)this.add(a[c]);return this},get:function(a){return"sprite"==a?d:"canvas"==a?e:void 0},remove:function(a){if(a instanceof b.Sprite&&-1!=d.indexOf(a))d.splice(index,1);else if(a instanceof l&&-1!=e.indexOf(a))e.splice(index,1);else if(h(a))for(var c=0;c<a.length;c++)this.remove(a[c]);return this},clear:function(){for(var a=0;a<e.length;a++){var b=e[a];b.clear()}return this},draw:function(){for(var a=0;a<d.length;a++){var b=d[a];b.visible&&b.canvas&&b.draw()}return this},redraw:function(a){this.clear();var b,c=this.calculateFps(a);for(b=0;b<e.length;b++)e[b].beforeUpdate(c);for(b=0;b<d.length;b++){var f=d[b];f.visible&&(f.update(a,c),f.draw())}for(b=0;b<e.length;b++)e[b].afterUpdate(c);return this}}}var c=null,d=[],e=[],f=[],g=0;return{instance:function(){return c||(c=a()),c}}}()});